<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../wc-i18n/wc-i18n.html">
<link rel="import" href="../../oak-i18n-behavior/oak-i18n-behavior.html">
<link rel="import" href="../fs-icon/fs-icon.html">

<!--
The styleguide person renderer

TODO: Looks like we need unit tests for this!

Example:

    <fs-person full-name='Josh Crowther' pid='KWFF-1RH' gender='male'></fs-person>

### Styling
You can use the `--fs-person-name`, `--fs-person-portrait`, `--fs-person-portrait-icon`, `--fs-person-portrait-image` and `--fs-person-container` mixin to style `fs-person` underneath:
```css
fs-person {
  --fs-person-name: {
    font-size: 14px;
  };
}

fs-person:not([inline]) {
  --fs-person: {
    width: 100%;
  };
  --fs-person-name: {
    font-size: 20px;
    font-family: museo, serif;
  };
  --fs-person-portrait: {
    height: 40px;
    width: 40px;
  };
  --fs-person-portrait-icon: {
    height: 100%;
    width: 100%;
  };
  --fs-person-portrait-image: {
    height: 100%;
    width: 100%;
  };
  --fs-person-container: {
    padding: 5px;
  };
}
```
@demo fs-person/demo/index.html
-->

<dom-module id="fs-person">
  <template>
    <style>
      *[hidden] {
        display: none !important;
      }
      :host {
        display: inline-block;
        max-width: 100%;
        /* z-index and position needed for hover tooltip to show above other elements.
         * This is because of the stacking context and how z-index applies to it.
         * Read more about the stacking context here:
         * https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Positioning/Understanding_z_index/The_stacking_context */
        z-index: 1;
        position: relative;
      }
      :host([inline]) .fs-person-vitals {
        display: flex;
        align-items: center;
      }
      :host([inline]) .fs-person-vitals__name {
        margin-right: 15px;
      }
      .fs-person-vitals,
      .fs-person-vitals__name-block {
        /*https://css-tricks.com/flexbox-truncated-text*/
        min-width: 0;
        width: 100%;
      }

      :host([orientation='portrait']) .fs-person-vitals {
        text-align: center;
      }

      .fs-person-vitals__name {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 14px;
        font-size: 1rem;
        font-weight: normal;
        line-height: 1.625rem;
        margin: 0;
        @apply(--fs-person-name);
      }
      .fs-person-name__container {
        display: -webkit-flex;
        display: flex;
        -webkit-flex-wrap: nowrap;
        flex-wrap: nowrap;
      }
      .fs-person-details__container {
        display: -webkit-flex;
        display: flex;
        -webkit-flex-wrap: nowrap;
        flex-wrap: nowrap;
        white-space: nowrap;
        @apply(--fs-person-details);
      }
      .fs-person-details__pid .copy-icon {
        cursor: pointer;
      }
      :host([orientation='portrait']) .fs-person-details__container {
        justify-content: center;
      }
      .fs-person-details__container.indented {
        margin-left:16px;
      }
      .v-center,
      .fs-person-portrait,
      .fs-person__container {
        display: flex;
        flex-direction: row;
        align-items: center;
        min-width: 0;
      }

      /* Bug fix to keep portrait container from shrinking in ie11. */
      .fs-person-portrait {
        flex-shrink: 0;
      }

      .fs-person__container > .v-center,
      .fs-person-vitals > .v-center {
        overflow-x: hidden;
        width: 100%;
      }
      :host([orientation='portrait']) .v-center {
        justify-content: center;
      }
      .fs-person__container {
        position: relative;
        z-index:0;
        @apply(--fs-person-container);
      }

      /* This is a CSS hack to allow for easy copying of the PID */
      #_pidInput {
        opacity: 0;
        position: absolute;
        width: 40px; /* Fix for OFT-69102 - copy pid not working for person-card or tree. */
        height: 1px;
        top:0;
        left:0;
        z-index: -1;
      }

      .copy-icon {
        height: 12px;
        position: relative;
        width: 15px;
      }

      /* Begin GitHub-like css-only accessible tooltip */
      .copy-pid-container {
        cursor: pointer;
        padding: 4px;
        margin-left:-2px;
      }

      .copy-pid-container:hover .tooltipped::before,
      .copy-pid-container:hover .tooltipped::after,
      .copy-pid-container:active .tooltipped::before,
      .copy-pid-container:active .tooltipped::after,
      .copy-pid-container:focus .tooltipped::before,
      .copy-pid-container:focus .tooltipped::after {
        display: inline-block;
        text-decoration: none;
      }

      .tooltipped::before {
        position: absolute;
        z-index: 1000001;
        display: none;
        width: 0;
        height: 0;
        color: rgba(0,0,0,0.8);
        content: "";
        border: 5px solid transparent;
      }

      .tooltipped::after {
        -webkit-transform: translateX(50%);
        transform: translateX(50%);
      }

      .tooltipped::after {
        top: 100%;
        right: 50%;
        margin-top: 5px;
      }

      .tooltipped::before {
        top: auto;
        right: 50%;
        bottom: -5px;
        margin-right: -5px;
        border-bottom-color: rgba(0,0,0,0.8);
      }

      .tooltipped::after {
        position: absolute;
        z-index: 1000000;
        display: none;
        padding: 5px 8px;
        -webkit-font-smoothing: subpixel-antialiased;
        color: #fff;
        text-align: center;
        text-decoration: none;
        text-shadow: none;
        text-transform: none;
        letter-spacing: normal;
        word-wrap: break-word;
        white-space: pre;
        content: attr(aria-label);
        background: rgba(0,0,0,0.8);
        border-radius: 3px;
      }

      /* End GitHub-like css-only accessible tooltip */

      .fs-person__container {
        color: #333331;
      }

      :host([orientation='portrait']) .fs-person__container {
        flex-direction: column;
      }

      .fs-person__container > .v-center {
        @apply(--fs-person-name-v-center);
      }

      .fs-person-gender__icon {
        margin-right: 8px;
      }

      .fs-person-portrait__container {
        background-color: #f4f4f4;
        background-position: center;
        background-size: 60%;
        border-radius: 50%;
        border: solid 4px #d9d9d9;
        box-shadow: 0 2px 3px 0 #636363;
        box-shadow: none;
        height: 66px;
        margin-right: 20px;
        width: 66px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
        @apply(--fs-person-portrait);
      }
      :host([orientation='portrait']) .fs-person-portrait__container {
        margin-right: 0;
      }
      .fs-person-portrait__portrait-icon[icon='female'],
      .fs-person-portrait__portrait-icon[icon='male'] {
        width: 100%;
        height: 100%;
        @apply(--fs-person-portrait-icon);
      }
      .fs-person-portrait__portrait-icon[icon^='gray'],
      .fs-person-portrait__portrait-icon[icon^='unknown'] {
        width: 60%;
        height: 60%;
        @apply(--fs-person-portrait-icon);
      }
      .fs-person-portrait__portrait-image {
        width: 100%;
        height: 100%;
        /* Bug fix so portraits and broken images don't appear side-by-side with icon: */
        position: absolute;
        top: 0px; /* Required for ie11 */
        left: 0px;
        @apply(--fs-person-portrait-image);
      }
      a:visited {
        color: blue;
      }
      a {
        text-decoration: none;
      }
      :host([inline]) a {
        color: #333331;
      }
      :host([inline]) a:hover {
        text-decoration: underline;
      }

      .fs-person-gender__icon[icon='male'],
      .fs-person-gender__icon[icon='female'] {
        height:26px;
        width:26px;
      }

      .fs-person-vitals__name {
        @apply(--person-name);
      }

      .fs-person-vitals__name:hover {
        text-decoration:underline;
        @apply(--person-name-hover);
      }

      .fs-person-details__container:hover {
        @apply(--person-details-hover);
      }

      .fs-person__container.locale-ja .fs-person-vitals__name-block p {
        font-family: "ヒラギノ角ゴ Pro W3","Hiragino Kaku Gothic Pro","メイリオ","Meiryo","ＭＳ ゴシック","MS Gothic",sans-serif;
      }

      .fs-person__container.locale-ko .fs-person-vitals__name-block p {
        font-family: "Apple SD Gothic Neo","애플고딕","AppleGothic","맑은 고딕","Malgun Gothic","굴림","Gulim",sans-serif;
      }

      .fs-person__container.locale-zh .fs-person-vitals__name-block p {
        font-family: "黑體-繁","Heiti TC","华文细黑","STXihei","微軟正黑體","Microsoft JengHei","中易黑体","SimHei","HanaMinB",sans-serif;
      }

      .fs-person__container .copy-pid-container span {
        font-family: Verdana, sans-serif;
      }

      .fs-person-details__separator{
        padding-left: 6px;
        padding-right: 6px;
        color: #333331;
      }
    </style>
    <div class$='fs-person__container locale-[[language]]' data-test-person='[[pid]]'>
      <div class="fs-person-portrait" hidden='[[inline]]'>
        <div class='fs-person-portrait__container' hidden='[[!showPortrait]]'>
          <template is='dom-if' if='[[portraitUrl]]'>
            <img class='fs-person-portrait__portrait-image' src="[[portraitUrl]]" on-error="handlePortraitError" data-test-person-portrait>
          </template>
          <fs-icon icon='[[_getGenderIcon(gender, coloredIcon)]]' class='fs-person-portrait__portrait-icon'></fs-icon>
        </div>
      </div>
      <div class='v-center'>
        <fs-icon class='fs-person-gender__icon' icon='[[gender]]' hidden='[[!_showGenderIcon(inline, dotIcon, showPortrait, gender, hideGender, orientation)]]'></fs-icon>
        <div class="fs-person-vitals">
          <div class='v-center'>
            <fs-icon class='fs-person-gender__icon' icon='[[gender]]-dot' size='small' hidden='[[!_showGenderDot(inline, dotIcon, showPortrait, hideGender, orientation)]]'></fs-icon>
            <span class="fs-person-vitals__name-block">
              <p class='fs-person-vitals__name' hidden='[[_isPortrait(orientation)]]' data-test-person-full-name><span class="person-label" hidden$="[[!label]]">[[label]]: </span>[[fullName]]</p>
              <p class='fs-person-vitals__name' hidden='[[!_isPortrait(orientation)]]'>
                <span class="person-label" hidden$="[[!label]]">[[label]]: </span>
                <span data-test-person-given-name>[[_getFirstName(firstName, lastName, nameSystem)]]</span>
                <span data-test-person-family-name>[[_getLastName(firstName, lastName, nameSystem)]]</span>
              </p>
            </span>
          </div>
          <div class$='fs-person-details__container [[_getDetailsClass(inline, dotIcon, showPortrait, hideGender, orientation)]]'>
            <span data-test-person-lifespan>[[lifespan]]</span>
            <div hidden$='[[!_showPid(pid, hidePid)]]'>
              <span class="fs-person-details__separator" hidden='[[_hideSeparator(hideSeparator, pid, lifespan)]]'>&#9679;</span><span data-test-person-pid>[[pid]]</span>
              <span class="copy-pid-container" on-click='_copyPid' class='fs-person-details__pid'>
                <fs-icon id="CopyPIDIcon" aria-label$='[[i18n("COPY_TO_CLIPBOARD")]]' title='' class='copy-icon tooltipped' icon='copy' data-test-person-copy-pid-button></fs-icon>
              </span>
              <input id='_pidInput' type="text" value$='[[pid]]'>
            </div>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
    Polymer({
      is: 'fs-person',
      properties: {
        /**
         * Whether or not to use a colored icon (instead of gray), used to compute the gender icon
         *
         * **Valid values are true or false**
         * @type {Boolean}
         */
        coloredIcon: {
          type: Boolean,
          value: false
        },

        /**
         * Whether or not to show the gender dot icon (instead of coloredIcon)
         *
         * **Valid values are true or false**
         * @type {Boolean}
         */
        dotIcon: {
          type: Boolean,
          value: false
        },

        /**
         * The full name of the person to be rendered (used only in landscape mode)
         * @type {String}
         */
        fullName: {
          type: String,
          value: ''
        },

        /**
         * The first name of the person to be rendered (used only in portrait mode)
         * @type {String}
         */
        firstName: {
          type: String,
          value: ''
        },

        /**
         * The last name of the person to be rendered (used only in portrait mode)
         * @type {String}
         */
        lastName: {
          type: String,
          value: ''
        },
        /**
         * The label used for a person.
         * @type {String}
         */
        label: {
          type: String,
          value: ''
        },

        /**
         * Whether the first/last name parts should be reversed
         *
         * **Valid values are `eurotypic` or `sinotypic`**
         * @type {String}
         */
        nameSystem: {
          type: String,
          value: 'eurotypic'
        },

        /**
         * The ID of the person to be displayed (if not passed simply hidden)
         * @type {String}
         */
        pid: {
          type: String,
          value: ''
        },

        /**
         * The lifespan of the person (if not passed simply hidden)
         * @type {String}
         */
        lifespan: {
          type: String,
          value: ''
        },

        /**
         * Gender of the person, used to compute the gender icon
         *
         * **Valid values are `male`, `female`, or `unknown`**
         * @type {String}
         */
        gender: {
          type: String,
          value: ''
        },

        /** Whether this element is hiding the gender icon. */
        hideGender: {
          type: Boolean,
          value: false
        },

        /**
         * Orientation of the person renderer
         *
         * **Valid values are `landscape` or `portrait`**
         * @type {String}
         */
        orientation: {
          type: String,
          value: 'landscape',
          reflectToAttribute: true
        },

        /**
         * Whether or not the portrait image should be shown
         * @type {Boolean}
         */
        showPortrait: {
          type: Boolean,
          value: false
        },

        /**
         * URL for the person portrait
         * @type {String}
         */
        portraitUrl: {
          type: String,
          value: ''
        },

        /**
         * Inline rendering of the person
         * @type {Boolean}
         */
        inline: {
          type: Boolean,
          value: false,
          reflectToAttribute: true
        },

        /**
         * Whether or not to show the spearator dot (•)
         * @type {Boolean}
         */
        hideSeparator: {
          type: Boolean,
          value: false
        },

        /**
         * Whether the person id should be shown
         * @type {Boolean}
         */
        hidePid: {
          type: Boolean,
          value: false
        }

      },
      behaviors: [
        WCI18n(),
        OakI18nBehavior
      ],
      observers: [
        '_portraitDefault(showPortrait, orientation)'
      ],

      handlePortraitError: function(e) {
        this.portraitUrl = false;
      },
      _copyPid: function(e) {
        var that = this,
            target = e.target;
        e.preventDefault();
        // Stop any other events from firing (like opening the person card or person page)
        e.stopImmediatePropagation();
        this.$._pidInput.select();
        document.execCommand('copy');
        this.$.CopyPIDIcon.setAttribute("aria-label", this.i18n("COPY_TO_CLIPBOARD_COMPLETE"));
        setTimeout(function(){
          that.$.CopyPIDIcon.setAttribute("aria-label", that.i18n("COPY_TO_CLIPBOARD"));
        }, 3000);
        window.getSelection().removeAllRanges();
      },
      _showPid: function(pid, hidePid) {
        return (pid && !hidePid);
      },
      _portraitDefault: function(showPortrait, orientation) {
        if (orientation === 'portrait' && !showPortrait) {
          this.showPortrait = true;
        }
      },
      _showGenderIcon: function(inline, dotIcon, showPortrait, gender, hideGender, orientation) {
        if (inline || dotIcon) return false;
        return gender && !hideGender && !showPortrait && !this._isPortrait(orientation);
      },
      _showGenderDot: function(inline, dotIcon, showPortrait, hideGender, orientation) {
        if ((inline && !hideGender) || (dotIcon && !hideGender)) return true;
        return !hideGender && showPortrait && !this._isPortrait(orientation);
      },
      _getDetailsClass: function(inline, dotIcon, showPortrait, hideGender, orientation) {
        return this._showGenderDot(inline, dotIcon, showPortrait, hideGender, orientation) ? 'indented' : '';
      },
      _getGender: function(gender) {
        if (gender === 'female') return gender;
        return 'male';
      },
      _getGenderIcon: function(gender, coloredIcon) {
        if (coloredIcon) {
          if (gender === 'female') {
            return 'female';
          }
          if (gender === 'male') {
            return 'male';
          }
        }
        if (gender === 'female') {
          return 'gray-female';
        }
        if (gender === 'male') {
          return 'gray-male';
        }

        return 'unknown-portrait';
      },
      _hideSeparator: function(hideSeparator, pid, lifespan) {
        return (hideSeparator || !(pid && lifespan));
      },
      _isPortrait: function(orientation) {
        return orientation === 'portrait';
      },
      _usingNameParts: function(first, last) { // Is this used anywhere?
        return first || last;
      },
      _getFirstName: function(first, last, nameSystem) {
        return nameSystem === 'sinotypic' ? last : first;
      },
      _getLastName: function(first, last, nameSystem) {
        return nameSystem === 'sinotypic' ? first : last;
      }
    });
  </script>
</dom-module>
